name: Publish SessionAttested Artifacts

on:
  workflow_dispatch:
    inputs:
      artifact_dir:
        description: "Path to prepared SessionAttested artifacts directory"
        required: true
        default: "attested_artifacts/latest"
  push:
    branches: [ main ]
    paths:
      - "attested_artifacts/latest/**"
      - ".github/workflows/publish-attested-artifact.yml"

jobs:
  upload-attested-artifact:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve artifact dir
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DIR="${{ github.event.inputs.artifact_dir }}"
          else
            DIR="attested_artifacts/latest"
          fi
          echo "dir=$DIR" >> "$GITHUB_OUTPUT"

      - name: Validate required files
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ steps.vars.outputs.dir }}"

          if [[ ! -d "$DIR" ]]; then
            echo "artifact dir not found: $DIR" >&2
            echo "--- repo files (maxdepth 4) ---"
            find . -maxdepth 4 -type f | sort | sed -n '1,300p'
            exit 1
          fi

          echo "--- artifact files (maxdepth 3) ---"
          find "$DIR" -maxdepth 3 -type f | sort

          req() {
            local p="$1"
            if [[ -f "$p" ]]; then
              echo "OK: $p"
            else
              echo "MISSING: $p" >&2
              exit 1
            fi
          }

          req "$DIR/ATTESTED"
          req "$DIR/ATTESTED_SUMMARY"
          req "$DIR/ATTESTED_POLICY_LAST"
          req "$DIR/attestation/attestation.json"
          req "$DIR/attestation/attestation.sig"
          req "$DIR/attestation/attestation.pub"
          req "$DIR/inputs/policy.yaml"

          if [[ -f "$DIR/inputs/commit_binding.json" ]]; then
            echo "OK: $DIR/inputs/commit_binding.json"
          elif [[ -f "$DIR/inputs/commit_bindings.jsonl" ]]; then
            echo "OK: $DIR/inputs/commit_bindings.jsonl"
          else
            echo "MISSING: commit binding file (commit_binding.json or commit_bindings.jsonl)" >&2
            exit 1
          fi

      - name: Generate manifest (sha256)
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ steps.vars.outputs.dir }}"
          (
            cd "$DIR"
            find . -type f | sort | while read -r f; do
              sha256sum "$f"
            done
          ) > "$DIR/SHA256SUMS"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: session-attested-${{ github.run_id }}
          path: |
            ${{ steps.vars.outputs.dir }}/ATTESTED
            ${{ steps.vars.outputs.dir }}/ATTESTED_SUMMARY
            ${{ steps.vars.outputs.dir }}/ATTESTED_POLICY_LAST
            ${{ steps.vars.outputs.dir }}/ATTESTED_WORKSPACE_OBSERVED
            ${{ steps.vars.outputs.dir }}/SHA256SUMS
            ${{ steps.vars.outputs.dir }}/attestation/**
            ${{ steps.vars.outputs.dir }}/inputs/**
            ${{ steps.vars.outputs.dir }}/audit/**
          if-no-files-found: error
          retention-days: 30
